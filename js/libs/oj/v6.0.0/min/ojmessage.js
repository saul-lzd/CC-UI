/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";define(["ojs/ojcore","jquery","knockout","ojs/ojcontext","ojs/ojthemeutils","ojs/ojtranslation","hammerjs","ojs/ojcomposite","ojs/ojcomponentcore","ojs/ojanimation","ojs/ojvalidation-base","ojs/ojlogger","ojs/ojjquery-hammer","ojs/ojknockout","ojs/ojbutton","ojs/ojvalidation-datetime"],function(e,t,o,i,s,n,a,r,p,d,c,u){function l(e){this._composite=e.element,this.containerId=[e.unique,"mc"].join("_"),this._messagesContainerId=this.containerId,this.handleCloseIcon=this._handleCloseIcon.bind(this),this.close=this._closeMessage.bind(this),this.bindingsApplied=this._bindingsApplied.bind(this),this.disconnected=this._disconnected.bind(this),this.connected=this._connected.bind(this),this.propertyChanged=this._propertyChanged.bind(this),this.messageCreatedTime=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),this.handleKeydown=this._handleKeydown.bind(this),this._properties=e.properties,this._createObservables()}function m(e,t){this._element=e,this._operation=t,this._init()}l.prototype._connected=function(e){var t=this._operationMediator;t&&"none"===t.getPendingOperation()&&this._isMessageOpen()&&this._scheduleAutoClose()},l.prototype._disconnected=function(e){var t=this._operationMediator;t&&"none"===t.getPendingOperation()&&this._clearAutoClose()},l.prototype._bindingsApplied=function(e){this._openMessage()},l.prototype._propertyChanged=function(e){function t(e,t,o){if("external"===e.updatedFrom&&e.property===t){var i=e.subproperty;if(i)return[t,o].join(".")===i.path;var s=e.previousValue[o];return e.value[o]!==s}return!1}t(e,"message","autoTimeout")&&(this._clearAutoClose(),this._scheduleAutoClose()),t(e,"message","closeAffordance")&&(this.hasCloseAffordance("defaults"===this._computeCloseAffordance()),this._unregisterSwipeHandler(),this._registerSwipeHandler()),t(e,"message","icon")&&(this.computedIconStyle(this._computeIconStyle()),this.computedIconClass(this._computeIconClass())),t(e,"message","category")&&this.computedCategory(this._computeCategory()),t(e,"message","severity")&&(this.computedSeverity(this._computeSeverity()),this.computedCategory(this._computeCategory()),this.computedIconClass(this._computeIconClass())),t(e,"message","timestamp")&&this.computedTimestamp(this._computeTimestamp()),t(e,"message","summary")&&this.computedSummary(this._computeSummary()),t(e,"message","detail")&&this.computedDetail(this._computeDetail()),t(e,"translations","labelCloseIcon")&&this.computedLabelCloseIcon(this._computeLabelCloseIcon()),t(e,"translations","categories")&&this.computedCategory(this._computeCategory())},l.prototype._registerSwipeHandler=function(){if(e.DomUtils.isTouchSupported()&&"defaults"===this._computeCloseAffordance()){var o=t(document.getElementById(this._messagesContainerId)),i={recognizers:[[a.Swipe,{direction:a.DIRECTION_HORIZONTAL}]]},s="rtl"===e.DomUtils.getReadingDirection()?"swipeleft":"swiperight";this._hammerSwipe=o.ojHammer(i).on(s,function(e){e.preventDefault(),this._closeMessage()}.bind(this))}},l.prototype._unregisterSwipeHandler=function(){if(e.DomUtils.isTouchSupported()&&this._hammerSwipe){var t="rtl"===e.DomUtils.getReadingDirection()?"swipeleft":"swiperight";this._hammerSwipe.off(t),delete this._hammerSwipe}},l.prototype._scheduleAutoClose=function(){this._computeAutoTimeout()>-1&&(this._autoCloseTimer=window.setTimeout(this._closeMessage.bind(this),this._computeAutoTimeout()))},l.prototype._clearAutoClose=function(){isNaN(this._autoCloseTimer)||(window.clearTimeout(this._autoCloseTimer),delete this._autoCloseTimer)},l.prototype._isMessageOpen=function(){var e=document.getElementById(this._messagesContainerId);return!(!e||!t(e).is(":visible"))},l.prototype._closeMessage=function(e){var o=document.getElementById(this._messagesContainerId);if(o){var i=this._operationMediator;if(this._unregisterSwipeHandler(),i.isOperationPending("close",this._closeMessage.bind(this,e)))return;i.destroy(),this._clearAutoClose(),this._operationMediator=new m(this._composite,"close");var s=this._getAnimateOptionDefaults("close");d.startAnimation(o,"close",s,this._composite).then(function(){t(o).hide(),p.subtreeHidden(o);var i={bubbles:!0,cancelable:!1,detail:{message:this._properties.message}},s=new CustomEvent("ojClose",i);e&&Object.defineProperty(s,"_originalEvent",{value:e,writable:!1}),this._composite.dispatchEvent(s)}.bind(this))}},l.prototype._computeSeverity=function(){var t=this._properties.message;return e.StringUtils.isEmptyOrUndefined(t.severity)?l._getMessageDefault("severity"):"fatal"===t.severity?"error":t.severity},l.prototype._computeTimestamp=function(){var t=this._properties.message;if(!e.StringUtils.isEmptyOrUndefined(t.timestamp))try{var o=c.Validation.converterFactory(e.ConverterFactory.CONVERTER_TYPE_DATETIME).createConverter({pattern:"MM/dd/yy, hh:mm a"}).format(t.timestamp);return this._isDateToday(t.timestamp)&&(o=o.split(", ")[1]),o}catch(e){return void u.info(["JET oj-message id='",l._toSelector(this._composite),"': failed to parse or format the supplied value to message.timestamp='",t.timestamp,"'."].join(""))}},l.prototype._isDateToday=function(e){var t=new Date,o=c.IntlConverterUtils.isoToLocalDate(e);return t.getUTCFullYear()===o.getUTCFullYear()&&t.getUTCMonth()===o.getUTCMonth()&&t.getUTCDate()===o.getUTCDate()},l.prototype._computeCategory=function(){var t=this._properties.message;if(!e.StringUtils.isEmptyOrUndefined(t.category))return t.category;var o=this._computeSeverity(),i=this._properties.translations,s=i&&i.categories?i.categories[o]:"";return e.StringUtils.isEmptyOrUndefined(s)&&(s=n.getComponentTranslations("oj-ojMessage").categories[o]),s},l.prototype._computeAutoTimeout=function(){var e=this._properties.message;return isNaN(e.autoTimeout)?l._getMessageDefault("autoTimeout"):0===e.autoTimeout?this._getThemedAutoTimeoutDefault():e.autoTimeout},l.prototype._computeIconStyle=function(){var t=this._properties.message;if(!e.StringUtils.isEmptyOrUndefined(t.icon))return["url('",t.icon,"') no-repeat"].join("")},l.prototype._computeIconClass=function(){var t=this._properties.message;if(e.StringUtils.isEmptyOrUndefined(t.icon)){var o=this._computeSeverity();if("none"!==o){var i=["oj-component-icon","oj-message-status-icon"];return i.push(["oj","message",o,"icon"].join("-")),i.join(" ")}}},l.prototype._computeCloseAffordance=function(){var t=this._properties.message;return e.StringUtils.isEmptyOrUndefined(t.closeAffordance)?l._getMessageDefault("closeAffordance"):t.closeAffordance},l.prototype._computeSound=function(){var e=this._properties.message;return void 0===e.sound?l._getMessageDefault("sound"):e.sound},l.prototype._computeLabelCloseIcon=function(){var t=this._properties.translations;return e.StringUtils.isEmptyOrUndefined(t.labelCloseIcon)?n.getTranslatedString("oj-ojMessage.labelCloseIcon"):t.labelCloseIcon},l.prototype._computeSummary=function(){var t=this._properties.message;if(!e.StringUtils.isEmptyOrUndefined(t.summary))return t.summary},l.prototype._computeDetail=function(){var t=this._properties.message;if(!e.StringUtils.isEmptyOrUndefined(t.detail))return t.detail},l.prototype._handleCloseIcon=function(e){this._closeMessage(e)},l.prototype._openMessage=function(){this._operationMediator=new m(this._composite,"open"),Promise.resolve().then(function(){var e=document.getElementById(this._messagesContainerId);if(e){var t={bubbles:!0,cancelable:!1,detail:{message:this._properties.message}};this._composite.dispatchEvent(new CustomEvent("ojBeforeOpen",t));var o=this._getAnimateOptionDefaults("open");d.startAnimation(e,"open",o,this._composite).then(function(){t={bubbles:!0,cancelable:!1,detail:{message:this._properties.message}};var e=this._computeSound();"none"!==e&&(this._initAudioContext(),this._playSound(e)),this._registerSwipeHandler(),this._scheduleAutoClose(),this._composite.dispatchEvent(new CustomEvent("ojOpen",t))}.bind(this))}}.bind(this))},l.prototype._handleKeydown=function(e){e.defaultPrevented||"defaults"!==this._computeCloseAffordance()||e.keyCode===t.ui.keyCode.ESCAPE&&(e.preventDefault(),this._closeMessage(e))},l.prototype._playSound=function(e){if("defaults"!==e){var t=document.createElement("AUDIO");t.src=e,t.addEventListener("error",function(){u.info(["JET oj-message id='",l._toSelector(this._composite),"': failed to load or play media file for URL in property message.sound='",e,"'."].join(""))}.bind(this));var o=t.play();void 0!==o&&o.then(function(){}).catch(function(t){u.info(["JET oj-message id='",l._toSelector(this._composite),"': failed to load or play specified sound: '",e,"': error details: '",t].join(""))}.bind(this))}else if(void 0===window.audioContext)u.info(["JET oj-message id='",l._toSelector(this._composite),"': failed to load or play default sound for message because user agent does\n","not support Web Audio API'"].join(""));else{var i=window.audioContext.createGain();i.connect(window.audioContext.destination);var s=window.audioContext.createOscillator();s.connect(i),s.start(),s.stop(window.audioContext.currentTime+.01)}},l.prototype._initAudioContext=function(){if(void 0===window.audioContext)try{window.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){}},l.prototype._createObservables=function(){this.hasCloseAffordance=o.observable("defaults"===this._computeCloseAffordance()),this.computedIconStyle=o.observable(this._computeIconStyle()),this.computedIconClass=o.observable(this._computeIconClass()),this.computedSeverity=o.observable(this._computeSeverity()),this.computedCategory=o.observable(this._computeCategory()),this.computedTimestamp=o.observable(this._computeTimestamp()),this.computedLabelCloseIcon=o.observable(this._computeLabelCloseIcon()),this.computedSummary=o.observable(this._computeSummary()),this.computedDetail=o.observable(this._computeDetail())},l._getMessageDefault=function(e){return l._DEFAULTS.message[e]},l._DEFAULTS={autoTimeout:4e3,animation:{open:{effect:"fadeIn",duration:"300ms"},close:{effect:"fadeOut",duration:"300ms"}},message:{severity:"none",autoTimeout:-1,closeAffordance:"defaults",sound:"none"}},l.prototype._getThemedAutoTimeoutDefault=function(){var e=s.parseJSONFromFontFamily("oj-message-option-defaults");return e&&e.autoTimeout?e.autoTimeout:l._DEFAULTS.autoTimeout},l.prototype._getAnimateOptionDefaults=function(e){return l._DEFAULTS.animation[e]},l._toSelector=function(e){var t="";if(e)if(e.id&&e.id.length>0)t="#"+e.id;else{t=e.nodeName;var o=e.getAttribute("class");if(o&&(t+="."+o.split(" ").join(".")),e.parentNode)return l._toSelector(e.parentNode)+" > "+t}return t},m.prototype._init=function(){this._resolvedQueue=[],this._callback=this._eventHandler.bind(this);var e=this._operation,t=["oj"];t.push(e.charAt(0).toUpperCase()),t.push(e.slice(1));var o=t.join("");this._eventType=o,this._element.addEventListener(o,this._callback);var s=i.getContext(this._element).getBusyContext(),n={description:this._getBusyStateDescription.bind(this,this._element,this._operation)},a=s.addBusyState(n);this.addPromiseExecutor(function(e){window.setImmediate(function(){e()})}.bind(this,a))},m.prototype._getBusyStateDescription=function(e,t){return[e.nodeName," identified by '",l._toSelector(e),"' is busy animating on the '",t,"' operation."].join("")},m.prototype._deliverResolved=function(e){var t=this._resolvedQueue;this._resolvedQueue=[],e=e||this._operation,this._operation=null;for(var o=0;o<t.length;o++)t[o](e)},m.prototype.destroy=function(){this._deliverResolved("none"),this._callback=null,this._element=null,this._operation=null,this._eventType=null},m.prototype._eventHandler=function(e){e.target===this._element&&(this._element.removeEventListener(e.type,this._callback),this._deliverResolved(),this._callback=null)},m.prototype.getPendingOperation=function(){return this._operation?this._operation:"none"},m.prototype.addPromiseExecutor=function(e,t){this._resolvedQueue.push(e)},m.prototype.isOperationPending=function(e,t){if(!this._element)return!1;var o=!1,i=this.getPendingOperation();return e===i?(u.info(["An oj-message id='",l._toSelector(this._element),"' invoked a '",e,"' operation while pending animation of the same type of operation. ","The second request will be ignored."].join("")),o=!0):"none"!==i&&(u.info(["An oj-message id='",l._toSelector(this._element),"' invoked a '",e,"' operation while pending animation of a '",i,"' operation. The second request will be invoked after the pending ","operation completes."].join("")),this.addPromiseExecutor(t),o=!0),o},r.register("oj-message",{view:'<div :id="[[containerId]]" class="oj-message-container" on-keydown="[[handleKeydown]]">  <div class="oj-message-header">    <div class="oj-message-leading-header" :title="[[computedCategory]]">      <oj-bind-if test="[[computedIconStyle]]">        <div class="oj-component-icon oj-message-status-icon oj-message-custom-icon" role="img"          :style.background="[[computedIconStyle]]">        </div>      </oj-bind-if>      <oj-bind-if test="[[computedIconClass]]">        <div role="img"           :class="[[computedIconClass]]">         </div>      </oj-bind-if>      <oj-bind-if test="[[computedCategory]]">        <div class="oj-message-category" tabindex="-1">          <h1 :title="[[computedCategory]]">            <oj-bind-text value="[[computedCategory]]"></oj-bind-text>           </h1>        </div>      </oj-bind-if>    </div>    <div class="oj-message-trailing-header">      <oj-bind-if test="[[computedTimestamp]]">        <div class="oj-message-timestamp">          <oj-bind-text value="[[computedTimestamp]]"></oj-bind-text>         </div>      </oj-bind-if>      <oj-bind-if test="[[hasCloseAffordance]]">        <div class="oj-message-close">          <oj-button display="icons" chroming="half" on-click="[[handleCloseIcon]]">            <span slot="startIcon" class="oj-fwk-icon oj-fwk-icon-cross"></span>            <span>              <oj-bind-text value="[[computedLabelCloseIcon]]"></oj-bind-text>            </span>          </oj-button>        </div>      </oj-bind-if>    </div>    </div>  <div class="oj-message-body">    <div class="oj-message-summary">      <oj-bind-text value="[[computedSummary]]"></oj-bind-text>    </div>    <div class="oj-message-detail">      <oj-bind-text value="[[computedDetail]]"></oj-bind-text>    </div>  <div></div>',viewModel:l,metadata:{properties:{message:{type:"object",properties:{autoTimeout:{type:"number",value:-1},category:{type:"string",value:""},closeAffordance:{type:"string",enumValues:["defaults","none"],value:"defaults"},detail:{type:"string",value:""},icon:{type:"string",value:""},severity:{type:"string",enumValues:["confirmation","error","info","none","warning"],value:"none"},sound:{type:"string",value:"none"},summary:{type:"string",value:""},timestamp:{type:"string",value:""}}},translations:{type:"object",value:{},properties:{categories:{type:"object",properties:{confirmation:{type:"string"},error:{type:"string"},info:{type:"string"},warning:{type:"string"}}},labelCloseIcon:{type:"string"}}}},methods:{close:{},setProperty:{},getProperty:{},setProperties:{},getNodeBySubId:{},getSubIdByNode:{}},events:{ojClose:{},ojAnimateStart:{},ojAnimateEnd:{}},extension:{}}})});