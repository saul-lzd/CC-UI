/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";define(["ojs/ojcore","ojs/ojhtmlutils","ojs/ojlogger","promise","ojs/ojcustomelement","ojs/ojcomposite-knockout"],function(e,t,o){e.Composite={};e.Composite;return e.Composite.getMetadata=function(t){var o=e.Composite.getComponentMetadata(t);return o?Promise.resolve(o):null},e.Composite.getComponentMetadata=function(t){var o=e.BaseCustomElementBridge.getRegistered(t);return o&&o.composite?e.BaseCustomElementBridge.__GetDescriptor(t)[e.BaseCustomElementBridge.DESC_KEY_META]:null},e.Composite.register=function(t,o){e.CompositeElementBridge.register(t,o)},e.Composite.getContainingComposite=function(t,o){for(var r=null,i=t;i;)if((i=e.CompositeTemplateRenderer.getEnclosingComposite(i))&&"oj-module"!==i.nodeName.toLowerCase()){if(o&&!(16&t.compareDocumentPosition(o)))break;r=i}return r},e.Composite.getBindingProviderName=function(t){return t?t[e.Composite.__BINDING_PROVIDER]:null},e.Composite.__COMPOSITE_PROP="__oj_composite",e.Composite.__BINDING_PROVIDER="__oj_binding_prvdr",e.CompositeElementBridge={},e.CompositeElementBridge.proto=Object.create(e.BaseCustomElementBridge.proto),e.CollectionUtils.copyInto(e.CompositeElementBridge.proto,{beforePropertyChangedEvent:function(t,o,r){var i={property:o};e.CollectionUtils.copyInto(i,r),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"propertyChanged",[i])},AddComponentMethods:function(t){var o=function(t,o,r,i,n,s){if(!o.SaveEarlyPropertySet(r,i)){var a=o.SetProperty(t,r,i,n,s);if(a.propertySet)if(a.isSubproperty)e.CompositeElementBridge._getPropertyTracker(o,a.property).valueHasMutated()}};t.setProperty=function(t,r){var i=e.BaseCustomElementBridge.getInstance(this);o(this,i,t,r,this,!0)},t.getProperty=function(t){return e.BaseCustomElementBridge.getInstance(this).GetProperty(this,t,this)},t._propsProto.setProperty=function(e,t){o(this._ELEMENT,this._BRIDGE,e,t,this,!1)},t._propsProto.getProperty=function(e){return this._BRIDGE.GetProperty(this,e,this)},t.getNodeBySubId=function(t){var o=e.BaseCustomElementBridge.getInstance(this),r=o._getViewModel(this);return r.getNodeBySubId?r.getNodeBySubId(t,o._getNodeBySubId.bind(this)):o._getNodeBySubId.bind(this)(t)},t.getSubIdByNode=function(t){var o=e.BaseCustomElementBridge.getInstance(this),r=o._getViewModel(this);return r.getSubIdByNode?r.getSubIdByNode(t,o._getSubIdByNode.bind(this)):o._getSubIdByNode.bind(this)(t)}},CreateComponent:function(t){for(var o={},r=e.BaseCustomElementBridge.getSlotMap(t,!0),i=Object.keys(r),n=0;n<i.length;n++){var s=i[n];o[s]=r[s].length}this._SLOT_MAP=r;var a={element:t,props:Promise.resolve(this._PROPS),properties:this._PROPS,slotNodeCounts:Promise.resolve(o),slotCounts:o,unique:e.BaseCustomElementBridge.__GetUnique()};a.uniqueId=t.id?t.id:a.unique,this._VM_CONTEXT=a;var d=e.BaseCustomElementBridge.__GetDescriptor(t.tagName)[e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL];d="function"==typeof d?new d(a):e.CompositeTemplateRenderer.invokeViewModelMethod(d,"initialize",[a])||d,this._VIEW_MODEL=d;var m=e.CompositeTemplateRenderer.invokeViewModelMethod(d,"activated",[a])||Promise.resolve(!0),u=this;m.then(function(){var r={props:u._PROPS,slotMap:u._SLOT_MAP,slotNodeCounts:o,unique:u._VM_CONTEXT.unique,uniqueId:u._VM_CONTEXT.uniqueId,viewModel:u._VIEW_MODEL,viewModelContext:u._VM_CONTEXT};Object.defineProperty(t,e.Composite.__BINDING_PROVIDER,{value:"knockout"}),e.Components&&e.Components.unmarkPendingSubtreeHidden(t);var i=e.BaseCustomElementBridge.__GetCache(t.tagName),n=e.CompositeElementBridge._getDomNodes(i.view,t);e.CompositeTemplateRenderer.renderTemplate(r,t,n),u.__READY_TO_FIRE=!0,u.resolveDelayedReadyPromise()}).catch(function(e){u.throwError(t,e)})},DefineMethodCallback:function(t,o,r){t[o]=function(){var t=r.internalName||o,i=e.BaseCustomElementBridge.getInstance(this)._getViewModel(this);return i[t].apply(i,arguments)}},DefinePropertyCallback:function(t,o,r){var i=function(t,i){if(!this._BRIDGE.SaveEarlyPropertySet(o,t)){var n=e.CompositeElementBridge._getPropertyTracker(this._BRIDGE,o),s=n.peek();if(!e.BaseCustomElementBridge.__CompareOptionValues(o,r,t,s)&&(i&&(t=this._BRIDGE.ValidatePropertySet(this._ELEMENT,o,t)),r._eventListener&&this._BRIDGE.SetEventListenerProperty(this._ELEMENT,o,t),n(t),!r._derived)){var a=i?"external":"internal";e.BaseCustomElementBridge.__FirePropertyChangeEvent(this._ELEMENT,o,t,s,a)}}},n=function(t){var i=e.CompositeElementBridge._getPropertyTracker(this._BRIDGE,o),n=t?i.peek():i();return void 0===n&&i(n=this._BRIDGE.GetDefaultValue(r)),n};r._derived||e.BaseCustomElementBridge.__DefineDynamicObjectProperty(t._propsProto,o,function(){return n.bind(this,!1)()},function(e){i.bind(this)(e,!1)}),e.BaseCustomElementBridge.__DefineDynamicObjectProperty(t,o,function(){var t=e.BaseCustomElementBridge.getInstance(this);return n.bind(t._PROPS,!0)()},function(t){var o=e.BaseCustomElementBridge.getInstance(this);i.bind(o._PROPS)(t,!0)})},GetMetadata:function(e){return e._metadata},HandleDetached:function(t){e.BaseCustomElementBridge.proto.HandleDetached.call(this,t),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"detached",[t]),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"disconnected",[t])},HandleReattached:function(t){e.BaseCustomElementBridge.proto.HandleReattached.call(this,t),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"connected",[this._VM_CONTEXT])},InitializeElement:function(t){var o;e.BaseCustomElementBridge.proto.InitializeElement.call(this,t),e.Components&&e.Components.markPendingSubtreeHidden(t);var r=e.BaseCustomElementBridge.__GetCache(t.tagName);if(!r.view){var i=(o=e.BaseCustomElementBridge.__GetDescriptor(t.tagName))[e.BaseCustomElementBridge.DESC_KEY_VIEW];r.view||(r.view="string"==typeof i?e.CompositeElementBridge._getDomNodes(i,t):i)}if(!r.css){o||(o=e.BaseCustomElementBridge.__GetDescriptor(t.tagName));var n=o[e.BaseCustomElementBridge.DESC_KEY_CSS];if(n){var s=document.createElement("style");s.type="text/css",s.styleSheet?s.styleSheet.cssText=n:s.appendChild(document.createTextNode(n)),document.head.appendChild(s),r.css=!0}}e.BaseCustomElementBridge.__InitProperties(t,this._PROPS)},InitializePrototype:function(t){e.BaseCustomElementBridge.proto.InitializePrototype.call(this,t),Object.defineProperty(t,"_propsProto",{value:{}})},InitializeBridge:function(t){e.BaseCustomElementBridge.proto.InitializeBridge.call(this,t),t._propsProto&&(this._PROPS=Object.create(t._propsProto),this._PROPS._BRIDGE=this,this._PROPS._ELEMENT=t)},_getNodeBySubId:function(t){var o=e.CompositeElementBridge.__GetSubIdMap(this)[t.subId];if(o){if(o.alias){var r=e.CollectionUtils.copyInto({},t,void 0,!0);r.subId=o.alias;var i=o.node;return i.getNodeBySubId?i.getNodeBySubId(r):e.Components.__GetWidgetConstructor(i)("getNodeBySubId",r)}return o.node}return null},_getSubIdByNode:function(t){if(!this.contains(t))return null;var o,r,i,n=e.CompositeElementBridge.__GetNodeMap(this),s=e.Composite.getContainingComposite(t,this);if(null!=s){if((r=n[o=s.node.getAttribute("data-oj-subid-map")])&&s.getSubIdByNode&&(i=s.getSubIdByNode(t))){var a=r.map[i.subId];return i.subId=a,i}return null}for(var d=t;d!==this&&!(o=d.getAttribute("data-oj-subid-map")||d.getAttribute("data-oj-subid"));)d=d.parentNode;if(r=n[o]){if(!r.map)return{subId:o};var m=r.node;if(i=m.getSubIdByNode?m.getSubIdByNode(t):e.Components.__GetWidgetConstructor(m)("getSubIdByNode",t))return i.subId=r.map[i.subId],i}return null},_getViewModel:function(e){return this._VIEW_MODEL||this.throwError(e,"Cannot access methods before element is upgraded."),this._VIEW_MODEL}}),e.CompositeElementBridge.register=function(t,r){var i={};if(i[e.BaseCustomElementBridge.DESC_KEY_META]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_META),i[e.BaseCustomElementBridge.DESC_KEY_VIEW]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_VIEW),i[e.BaseCustomElementBridge.DESC_KEY_CSS]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_CSS),i[e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL]=e.CompositeElementBridge._getResource(r,e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL),i[e.BaseCustomElementBridge.DESC_KEY_PARSE_FUN]=r[e.BaseCustomElementBridge.DESC_KEY_PARSE_FUN],e.BaseCustomElementBridge.__Register(t,i,e.CompositeElementBridge.proto,!0)){var n=i[e.BaseCustomElementBridge.DESC_KEY_META];if(n||(o.warn("Composite registered'"+t.toLowerCase()+"' without Metadata."),n={}),null==i[e.BaseCustomElementBridge.DESC_KEY_VIEW])throw new Error("Cannot register composite '"+t.toLowerCase()+"' without a View.");i._metadata=e.BaseCustomElementBridge.__ProcessEventListeners(n,!1),customElements.define(t.toLowerCase(),e.CompositeElementBridge.proto.getClass(i))}},e.CompositeElementBridge._getDomNodes=function(o,r){var i,n;if("string"==typeof o)return t.stringToNodeArray(o);if(e.CompositeElementBridge._isDocumentFragment(o)){n=o.cloneNode(!0);var s=[];for(i=0;i<n.childNodes.length;i++)s.push(n.childNodes[i]);return s}if(Array.isArray(o)){for(n=[],i=0;i<o.length;i++)n.push(o[i].cloneNode(!0));return n}e.BaseCustomElementBridge.getInstance(r).throwError(r,"The composite View is not one of the following supported types: string, Array of DOM nodes, DocumentFragment")},e.CompositeElementBridge._generateSubIdMap=function(t,o){if(!t._SUBID_MAP){for(var r={},i={},n=o.children,s=0;s<n.length;s++)e.CompositeElementBridge._walkSubtree(r,i,n[s]);t._NODE_MAP=i,t._SUBID_MAP=r}},e.CompositeElementBridge._walkSubtree=function(t,o,r){if(!r.hasAttribute("slot")&&(e.CompositeElementBridge._addNodeToSubIdMap(t,o,r),!e.BaseCustomElementBridge.getRegistered(r.tagName)&&!e.Components.__GetWidgetConstructor(r)))for(var i=r.children,n=0;n<i.length;n++)e.CompositeElementBridge._walkSubtree(t,o,i[n])},e.CompositeElementBridge._addNodeToSubIdMap=function(e,t,o){var r=o.getAttribute("data-oj-subid"),i=o.getAttribute("data-oj-subid-map");if(i){var n=JSON.parse(i);if("object"==typeof n&&!(n instanceof Array)){for(var s=n,a={},d=Object.keys(s),m=0;m<d.length;m++){var u=d[m];e[u]={alias:s[u],node:o},a[s[u]]=u}t[i]={map:a,node:o}}}else r&&(e[r]={node:o},t[r]={node:o})},e.CompositeElementBridge.__GetSubIdMap=function(t){var o=e.BaseCustomElementBridge.getInstance(t);return e.CompositeElementBridge._generateSubIdMap(o,t),o._SUBID_MAP},e.CompositeElementBridge.__GetNodeMap=function(t){var o=e.BaseCustomElementBridge.getInstance(t);return e.CompositeElementBridge._generateSubIdMap(o,t),o._NODE_MAP},e.CompositeElementBridge._getPropertyTracker=function(t,o){return t._TRACKERS||(t._TRACKERS={}),t._TRACKERS[o]||(t._TRACKERS[o]=e.CompositeTemplateRenderer.createTracker()),t._TRACKERS[o]},e.CompositeElementBridge._getResource=function(e,t){var o=e[t];if(null!=o){var r=Object.prototype.hasOwnProperty;if(r.call(o,"inline"))return o.inline;if(r.call(o,"promise"))throw new Error("The 'promise' resource type for descriptor key '"+t+"' is no longer supported. The resource should be passed directly as the value instead.");return o}},e.CompositeElementBridge._isDocumentFragment=function(e){return window.DocumentFragment?e instanceof DocumentFragment:e&&11===e.nodeType},e.Composite});